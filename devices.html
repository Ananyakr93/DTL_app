<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Devices - AeroClean</title>
    <meta name="description" content="Connected devices and anomaly detection for air quality monitoring">
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <div class="dashboard">
        <aside class="sidebar">
            <h2 class="logo">üåø AeroClean</h2>
            <ul>
                <li onclick="location.href='index.html'">
                    <span class="icon">üìä</span>
                    <span>Dashboard</span>
                </li>
                <li onclick="location.href='analytics.html'">
                    <span class="icon">üìà</span>
                    <span>Analytics</span>
                </li>
                <li class="active">
                    <span class="icon">üì°</span>
                    <span>Devices</span>
                </li>
                <li onclick="location.href='reports.html'">
                    <span class="icon">üìë</span>
                    <span>Reports</span>
                </li>
                <li onclick="location.href='settings.html'">
                    <span class="icon">‚öôÔ∏è</span>
                    <span>Settings</span>
                </li>
            </ul>
        </aside>

        <main class="main">
            <header class="topbar">
                <h1>üì° Connected Devices & Anomaly Detection</h1>
                <div class="search-box">
                    <input type="text" id="citySearch" placeholder="üîç Search city for anomalies..." value="Bangalore">
                    <button onclick="checkAnomaly()">Check Anomalies</button>
                </div>
            </header>

            <!-- Anomaly Detection Section -->
            <section class="activity" id="anomalySection">
                <h2>üö® Real-Time Anomaly Detection</h2>
                <div id="anomalyResult" style="padding: 20px;">
                    <p style="color: #666;">Click "Check Anomalies" to analyze current air quality for unusual patterns.
                    </p>
                </div>
            </section>

            <section class="cards">
                <div class="card good">
                    <div class="card-header">
                        <h3>Total Devices</h3>
                        <span class="icon">üì±</span>
                    </div>
                    <p class="value">3</p>
                </div>

                <div class="card moderate">
                    <div class="card-header">
                        <h3>Active</h3>
                        <span class="icon">üü¢</span>
                    </div>
                    <p class="value">2</p>
                </div>

                <div class="card poor">
                    <div class="card-header">
                        <h3>Offline</h3>
                        <span class="icon">üî¥</span>
                    </div>
                    <p class="value">1</p>
                </div>

                <div class="card" id="anomalyCard">
                    <div class="card-header">
                        <h3>Anomalies Detected</h3>
                        <span class="icon">‚ö†Ô∏è</span>
                    </div>
                    <p class="value" id="anomalyCount">0</p>
                </div>
            </section>

            <section class="activity">
                <h2>üìã Device List</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Device ID</th>
                            <th>Location</th>
                            <th>Status</th>
                            <th>Last Update</th>
                            <th>Current AQI</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>SENSOR-001</strong></td>
                            <td>üìç Bangalore Central</td>
                            <td><span style="color: #4caf50;">üü¢ Active</span></td>
                            <td>2 mins ago</td>
                            <td><span style="color: #4caf50; font-weight: 600;">45 (Good)</span></td>
                            <td>
                                <button onclick="viewDevice('SENSOR-001')">View</button>
                                <button style="background: #f44336;"
                                    onclick="removeDevice('SENSOR-001')">Remove</button>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>SENSOR-002</strong></td>
                            <td>üìç Whitefield</td>
                            <td><span style="color: #4caf50;">üü¢ Active</span></td>
                            <td>5 mins ago</td>
                            <td><span style="color: #ffc107; font-weight: 600;">87 (Satisfactory)</span></td>
                            <td>
                                <button onclick="viewDevice('SENSOR-002')">View</button>
                                <button style="background: #f44336;"
                                    onclick="removeDevice('SENSOR-002')">Remove</button>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>SENSOR-003</strong></td>
                            <td>üìç Electronic City</td>
                            <td><span style="color: #f44336;">üî¥ Offline</span></td>
                            <td>2 hours ago</td>
                            <td><span style="color: #999;">-- (No Data)</span></td>
                            <td>
                                <button onclick="viewDevice('SENSOR-003')">View</button>
                                <button style="background: #f44336;"
                                    onclick="removeDevice('SENSOR-003')">Remove</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </section>

            <!-- Anomaly History -->
            <section class="activity" style="margin-top: 30px;">
                <h2>üìä Anomaly History</h2>
                <div id="anomalyHistory" style="padding: 20px;">
                    <table>
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>City</th>
                                <th>AQI</th>
                                <th>Severity</th>
                                <th>Root Cause</th>
                            </tr>
                        </thead>
                        <tbody id="anomalyHistoryBody">
                            <tr>
                                <td colspan="5" style="text-align: center; color: #666;">No anomalies recorded yet</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section class="activity" style="margin-top: 30px;">
                <h2>üîß Device Configuration</h2>
                <div style="padding: 20px;">
                    <h3>Sensor Calibration</h3>
                    <p style="color: #666; margin: 10px 0;">Configure sensor thresholds and alerts for connected
                        devices.</p>

                    <div style="margin-top: 20px;">
                        <label>Alert Threshold (AQI):</label>
                        <input type="number" value="100" id="alertThreshold">

                        <label>Data Collection Interval (minutes):</label>
                        <input type="number" value="5" id="collectionInterval">

                        <label>Enable Email Alerts:</label>
                        <select
                            style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 15px;">
                            <option>Yes</option>
                            <option>No</option>
                        </select>

                        <button onclick="saveConfiguration()">üíæ Save Configuration</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <style>
        .anomaly-alert {
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .anomaly-alert.high {
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
            border-left: 4px solid #f44336;
        }

        .anomaly-alert.medium {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
            border-left: 4px solid #ff9800;
        }

        .anomaly-alert.low {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            border-left: 4px solid #4caf50;
        }

        .anomaly-alert.none {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-left: 4px solid #2196f3;
        }

        .anomaly-metric {
            display: inline-block;
            padding: 5px 15px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 20px;
            margin: 5px;
            font-weight: 600;
        }
    </style>

    <script>
        const API_BASE = "http://127.0.0.1:5000";
        let anomalyLog = [];

        async function checkAnomaly() {
            const city = document.getElementById('citySearch').value.trim() || 'Bangalore';
            const resultDiv = document.getElementById('anomalyResult');

            resultDiv.innerHTML = '<p>Analyzing air quality patterns...</p>';

            try {
                const res = await fetch(`${API_BASE}/api/anomaly?city=${encodeURIComponent(city)}`);
                const data = await res.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                let alertClass = data.is_anomaly ? (data.severity || 'medium') : 'none';
                let alertIcon = data.is_anomaly ? '‚ö†Ô∏è' : '‚úÖ';
                let alertTitle = data.is_anomaly ? 'Anomaly Detected!' : 'No Anomaly Detected';

                resultDiv.innerHTML = `
            <div class="anomaly-alert ${alertClass}">
                <h3>${alertIcon} ${alertTitle}</h3>
                <div style="margin-top: 15px;">
                    <span class="anomaly-metric">Current AQI: ${data.current_aqi}</span>
                    <span class="anomaly-metric">Historical Avg: ${data.historical_avg}</span>
                    <span class="anomaly-metric">Deviation: ${data.deviation > 0 ? '+' : ''}${data.deviation}</span>
                    <span class="anomaly-metric">Score: ${data.anomaly_score}</span>
                </div>
                ${data.is_anomaly ? `
                    <div style="margin-top: 15px;">
                        <strong>Likely Root Cause:</strong> ${data.root_cause}
                    </div>
                    <div style="margin-top: 10px;">
                        <strong>Severity:</strong> <span style="text-transform: uppercase; color: ${data.severity === 'high' ? '#f44336' :
                            data.severity === 'medium' ? '#ff9800' : '#4caf50'
                        };">${data.severity}</span>
                    </div>
                ` : `
                    <div style="margin-top: 15px; color: #666;">
                        Air quality is within normal parameters for ${city}.
                    </div>
                `}
            </div>
        `;

                // Update anomaly count
                if (data.is_anomaly) {
                    const countEl = document.getElementById('anomalyCount');
                    countEl.innerText = parseInt(countEl.innerText) + 1;
                    document.getElementById('anomalyCard').className = 'card unhealthy';

                    // Add to history
                    anomalyLog.push({
                        timestamp: new Date().toLocaleString(),
                        city: city,
                        aqi: data.current_aqi,
                        severity: data.severity,
                        rootCause: data.root_cause
                    });
                    updateAnomalyHistory();
                }

            } catch (err) {
                console.error('Error checking anomaly:', err);
                resultDiv.innerHTML = `
            <div class="anomaly-alert none">
                <h3>‚ùå Error</h3>
                <p>Failed to check for anomalies: ${err.message}</p>
            </div>
        `;
            }
        }

        function updateAnomalyHistory() {
            const tbody = document.getElementById('anomalyHistoryBody');

            if (anomalyLog.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666;">No anomalies recorded yet</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            anomalyLog.slice().reverse().forEach(log => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
            <td>${log.timestamp}</td>
            <td>${log.city}</td>
            <td><strong>${log.aqi}</strong></td>
            <td><span style="color: ${log.severity === 'high' ? '#f44336' :
                        log.severity === 'medium' ? '#ff9800' : '#4caf50'
                    }; font-weight: 600; text-transform: uppercase;">${log.severity}</span></td>
            <td>${log.rootCause}</td>
        `;
                tbody.appendChild(tr);
            });
        }

        function addDevice() {
            const deviceId = prompt("Enter new device ID (e.g., SENSOR-004):");
            const location = prompt("Enter device location:");

            if (deviceId && location) {
                alert(`Device ${deviceId} added successfully at ${location}!`);
            }
        }

        function viewDevice(deviceId) {
            alert(`Viewing details for ${deviceId}
    
Location: Connected
Status: Active
Last Sync: 2 mins ago
Current AQI: 45 (Good)
PM2.5: 12.5 ¬µg/m¬≥
PM10: 25.3 ¬µg/m¬≥

This would show detailed device information and real-time graphs.`);
        }

        function removeDevice(deviceId) {
            if (confirm(`Are you sure you want to remove ${deviceId}?`)) {
                alert(`Device ${deviceId} removed successfully!`);
            }
        }

        function saveConfiguration() {
            const threshold = document.getElementById('alertThreshold').value;
            const interval = document.getElementById('collectionInterval').value;

            alert(`Configuration saved successfully!

Alert Threshold: ${threshold} AQI
Collection Interval: ${interval} minutes

Devices will be updated with new configuration.`);
        }

        // Check for anomalies on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Auto-check for current city
            setTimeout(checkAnomaly, 1000);
        });
    </script>

</body>

</html>