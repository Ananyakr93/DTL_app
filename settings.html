<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - AeroClean</title>
    <meta name="description" content="Configure your AeroClean dashboard preferences and health profile">
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <div class="dashboard">
        <aside class="sidebar">
            <h2 class="logo">üåø AeroClean</h2>
            <ul>
                <li onclick="location.href='index.html'">
                    <span class="icon">üìä</span>
                    <span>Dashboard</span>
                </li>
                <li onclick="location.href='analytics.html'">
                    <span class="icon">üìà</span>
                    <span>Analytics</span>
                </li>
                <li onclick="location.href='devices.html'">
                    <span class="icon">üì°</span>
                    <span>Devices</span>
                </li>
                <li onclick="location.href='reports.html'">
                    <span class="icon">üìë</span>
                    <span>Reports</span>
                </li>
                <li class="active">
                    <span class="icon">‚öôÔ∏è</span>
                    <span>Settings</span>
                </li>
            </ul>
        </aside>

        <main class="main">
            <h1>‚öôÔ∏è Settings</h1>

            <!-- Health Profile Section -->
            <section class="activity">
                <h2>üè• Health Profile</h2>
                <p style="color: #666; margin-bottom: 20px;">Set up your health profile for personalized air quality
                    recommendations.</p>
                <div style="padding: 20px;">
                    <label>Email Address:</label>
                    <input type="email" id="userEmail" placeholder="your.email@example.com">

                    <label>Name:</label>
                    <input type="text" id="userName" placeholder="Your name">

                    <label>Health Conditions (select all that apply):</label>
                    <div class="checkbox-group" style="margin-bottom: 15px;">
                        <label class="checkbox-label">
                            <input type="checkbox" id="conditionAsthma" value="asthma"> Asthma
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="conditionHeart" value="heart_disease"> Heart Disease
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="conditionElderly" value="elderly"> Elderly (65+)
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="conditionChildren" value="children"> Children in Household
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="conditionCOPD" value="copd"> COPD
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="conditionPregnant" value="pregnant"> Pregnant
                        </label>
                    </div>

                    <label>Personal AQI Alert Threshold:</label>
                    <input type="number" id="personalThreshold" value="100" min="50" max="300">
                    <small style="color: #666; display: block; margin-bottom: 15px;">
                        Get personalized alerts when AQI exceeds this value
                    </small>

                    <button onclick="saveHealthProfile()" style="margin-top: 10px;">üíæ Save Health Profile</button>
                </div>
            </section>

            <section class="activity" style="margin-top: 30px;">
                <h2>üìç Location Settings</h2>
                <div style="padding: 20px;">
                    <label>Default Location:</label>
                    <input type="text" id="defaultLocation" value="Bangalore" placeholder="Enter city name">

                    <label>Save Location History:</label>
                    <select id="saveHistory"
                        style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 15px;">
                        <option selected>Yes</option>
                        <option>No</option>
                    </select>

                    <label>Auto-detect Location:</label>
                    <select id="autoDetect"
                        style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 15px;">
                        <option>Yes</option>
                        <option selected>No</option>
                    </select>
                </div>
            </section>

            <section class="activity" style="margin-top: 30px;">
                <h2>üîî Notification Settings</h2>
                <div style="padding: 20px;">
                    <label>Alert Threshold (AQI):</label>
                    <input type="number" id="alertThreshold" value="100" placeholder="Enter AQI threshold">
                    <small style="color: #666; display: block; margin-bottom: 15px;">
                        Receive alerts when AQI exceeds this value
                    </small>

                    <label>Email Notifications:</label>
                    <select id="emailNotif"
                        style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 15px;">
                        <option selected>Enabled</option>
                        <option>Disabled</option>
                    </select>

                    <label>Push Notifications:</label>
                    <select id="pushNotif"
                        style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 15px;">
                        <option selected>Enabled</option>
                        <option>Disabled</option>
                    </select>

                    <label>Notification Email:</label>
                    <input type="email" id="notifEmail" value="" placeholder="your.email@example.com">
                </div>
            </section>

            <section class="activity" style="margin-top: 30px;">
                <h2>üé® Display Settings</h2>
                <div style="padding: 20px;">
                    <label>Theme:</label>
                    <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                        <button id="lightThemeBtn" onclick="setTheme('light')" class="theme-btn active">‚òÄÔ∏è
                            Light</button>
                        <button id="darkThemeBtn" onclick="setTheme('dark')" class="theme-btn">üåô Dark</button>
                        <button id="autoThemeBtn" onclick="setTheme('auto')" class="theme-btn">üåì Auto</button>
                    </div>

                    <label>AQI Standard:</label>
                    <select id="aqiStandard"
                        style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 15px;">
                        <option selected>Indian CPCB</option>
                        <option>US EPA</option>
                        <option>European EEA</option>
                    </select>

                    <label>Update Interval (minutes):</label>
                    <input type="number" id="updateInterval" value="5" min="1" max="60" placeholder="5">
                    <small style="color: #666; display: block; margin-bottom: 15px;">
                        How often to refresh air quality data (1-60 minutes)
                    </small>
                </div>
            </section>

            <section class="activity" style="margin-top: 30px;">
                <h2>üîê Privacy & Consent</h2>
                <div style="padding: 20px;">
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="gdprConsent">
                            I consent to the processing of my personal data for personalized recommendations (GDPR)
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="analyticsConsent" checked>
                            Allow anonymous usage analytics to improve the service
                        </label>
                    </div>

                    <div style="margin-top: 20px;">
                        <button onclick="exportData()" style="background: #2196f3;">üì§ Export My Data</button>
                        <button onclick="clearData()" style="background: #ff9800; margin-left: 10px;">üóëÔ∏è Clear
                            History</button>
                    </div>
                </div>
            </section>

            <section class="activity" style="margin-top: 30px;">
                <h2>‚ÑπÔ∏è About</h2>
                <div style="padding: 20px; color: #666;">
                    <p><strong>AeroClean Dashboard</strong></p>
                    <p>Version 3.0.0</p>
                    <p>Built with ‚ù§Ô∏è for cleaner air in India</p>
                    <p style="margin-top: 10px;">
                        <strong>Features:</strong>
                    </p>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>24-hour AQI predictions with uncertainty</li>
                        <li>Multi-source data fusion (AQICN + Open-Meteo)</li>
                        <li>Explainable AI for pollutant analysis</li>
                        <li>Anomaly detection with root cause analysis</li>
                    </ul>
                    <p style="margin-top: 15px;">
                        <a href="#" style="color: #a3ff12; text-decoration: none;">Privacy Policy</a> |
                        <a href="#" style="color: #a3ff12; text-decoration: none;">Terms of Service</a> |
                        <a href="#" style="color: #a3ff12; text-decoration: none;">Help & Support</a>
                    </p>
                </div>
            </section>

            <div style="margin-top: 30px; display: flex; gap: 15px;">
                <button onclick="saveSettings()" style="flex: 1; padding: 15px; font-size: 16px;">
                    üíæ Save All Settings
                </button>
                <button onclick="resetSettings()" style="flex: 1; padding: 15px; font-size: 16px; background: #f44336;">
                    üîÑ Reset to Default
                </button>
            </div>
        </main>
    </div>

    <style>
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            background: #f5f5f5;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .checkbox-label:hover {
            background: #e0e0e0;
        }

        .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .theme-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .theme-btn:hover {
            border-color: #a3ff12;
        }

        .theme-btn.active {
            background: #1c1f26;
            color: white;
            border-color: #a3ff12;
        }
    </style>

    <script>
        const API_BASE = "http://127.0.0.1:5000";

        // Apply theme on page load
        function applyTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark' || (savedTheme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }

            // Update button states
            document.querySelectorAll('.theme-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.getElementById(`${savedTheme}ThemeBtn`);
            if (activeBtn) activeBtn.classList.add('active');
        }

        function setTheme(theme) {
            localStorage.setItem('theme', theme);
            applyTheme();
        }

        // Load saved settings
        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('aqiSettings') || '{}');

            if (settings.defaultLocation) {
                document.getElementById('defaultLocation').value = settings.defaultLocation;
            }
            if (settings.alertThreshold) {
                document.getElementById('alertThreshold').value = settings.alertThreshold;
            }
            if (settings.updateInterval) {
                document.getElementById('updateInterval').value = settings.updateInterval;
            }
            if (settings.notifEmail) {
                document.getElementById('notifEmail').value = settings.notifEmail;
            }
            if (settings.userEmail) {
                document.getElementById('userEmail').value = settings.userEmail;
            }
            if (settings.userName) {
                document.getElementById('userName').value = settings.userName;
            }
            if (settings.healthConditions) {
                settings.healthConditions.split(',').forEach(condition => {
                    const checkbox = document.querySelector(`input[value="${condition}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            if (settings.gdprConsent) {
                document.getElementById('gdprConsent').checked = settings.gdprConsent;
            }
        }

        async function saveHealthProfile() {
            const email = document.getElementById('userEmail').value;
            const name = document.getElementById('userName').value;
            const threshold = document.getElementById('personalThreshold').value;
            const gdprConsent = document.getElementById('gdprConsent').checked;

            // Collect health conditions
            const conditions = [];
            ['conditionAsthma', 'conditionHeart', 'conditionElderly', 'conditionChildren', 'conditionCOPD', 'conditionPregnant'].forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox && checkbox.checked) {
                    conditions.push(checkbox.value);
                }
            });

            if (!email) {
                alert('Please enter your email address');
                return;
            }

            if (!gdprConsent) {
                alert('Please accept the GDPR consent to save your health profile');
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/api/user/profile`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: email,
                        name: name,
                        health_conditions: conditions.join(','),
                        alert_threshold: parseInt(threshold),
                        gdpr_consent: gdprConsent ? 1 : 0
                    })
                });

                const data = await res.json();

                if (data.success) {
                    // Save to localStorage too
                    const settings = JSON.parse(localStorage.getItem('aqiSettings') || '{}');
                    settings.userEmail = email;
                    settings.userName = name;
                    settings.healthConditions = conditions.join(',');
                    settings.personalThreshold = threshold;
                    settings.gdprConsent = gdprConsent;
                    localStorage.setItem('aqiSettings', JSON.stringify(settings));

                    alert('‚úÖ Health profile saved successfully!\n\nYou will receive personalized recommendations based on your health conditions.');
                } else {
                    throw new Error(data.error || 'Failed to save profile');
                }
            } catch (err) {
                console.error('Error saving profile:', err);
                // Save locally even if API fails
                const settings = JSON.parse(localStorage.getItem('aqiSettings') || '{}');
                settings.userEmail = email;
                settings.userName = name;
                settings.healthConditions = conditions.join(',');
                localStorage.setItem('aqiSettings', JSON.stringify(settings));
                alert('‚úÖ Health profile saved locally.\n\n(Note: Server sync failed, will retry later)');
            }
        }

        function saveSettings() {
            const settings = {
                defaultLocation: document.getElementById('defaultLocation').value,
                saveHistory: document.getElementById('saveHistory').value,
                autoDetect: document.getElementById('autoDetect').value,
                alertThreshold: document.getElementById('alertThreshold').value,
                emailNotif: document.getElementById('emailNotif').value,
                pushNotif: document.getElementById('pushNotif').value,
                notifEmail: document.getElementById('notifEmail').value,
                updateInterval: document.getElementById('updateInterval').value,
                aqiStandard: document.getElementById('aqiStandard').value,
                analyticsConsent: document.getElementById('analyticsConsent').checked
            };

            localStorage.setItem('aqiSettings', JSON.stringify(settings));
            localStorage.setItem('defaultCity', settings.defaultLocation);

            alert('‚úÖ Settings saved successfully!\n\nYour preferences have been updated and will be applied across all pages.');
        }

        function resetSettings() {
            if (confirm('Are you sure you want to reset all settings to default values?')) {
                localStorage.removeItem('aqiSettings');
                localStorage.removeItem('theme');
                localStorage.removeItem('defaultCity');
                location.reload();
            }
        }

        function exportData() {
            const data = {
                settings: JSON.parse(localStorage.getItem('aqiSettings') || '{}'),
                theme: localStorage.getItem('theme'),
                defaultCity: localStorage.getItem('defaultCity'),
                exportDate: new Date().toISOString(),
                version: '3.0.0'
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `aeroclean-data-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);

            alert('üì§ Your data has been exported successfully!');
        }

        function clearData() {
            if (confirm('‚ö†Ô∏è This will delete all your history and cached data. Are you sure?')) {
                if (confirm('This action cannot be undone. Continue?')) {
                    localStorage.clear();
                    alert('üóëÔ∏è All data cleared successfully!');
                    location.reload();
                }
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            applyTheme();
            loadSettings();
        });
    </script>

</body>

</html>