<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - AeroClean</title>
    <meta name="description" content="Generate and download air quality reports in PDF and Excel formats">
    <link rel="stylesheet" href="style.css">
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body>

    <div class="dashboard">
        <aside class="sidebar">
            <h2 class="logo">ğŸŒ¿ AeroClean</h2>
            <ul>
                <li onclick="location.href='index.html'">
                    <span class="icon">ğŸ“Š</span>
                    <span>Dashboard</span>
                </li>
                <li onclick="location.href='analytics.html'">
                    <span class="icon">ğŸ“ˆ</span>
                    <span>Analytics</span>
                </li>
                <li onclick="location.href='devices.html'">
                    <span class="icon">ğŸ“¡</span>
                    <span>Devices</span>
                </li>
                <li class="active">
                    <span class="icon">ğŸ“‘</span>
                    <span>Reports</span>
                </li>
                <li onclick="location.href='settings.html'">
                    <span class="icon">âš™ï¸</span>
                    <span>Settings</span>
                </li>
            </ul>
        </aside>

        <main class="main">
            <header class="topbar">
                <h1>ğŸ“‘ Air Quality Reports</h1>
                <button onclick="generateCustomReport()">+ Generate Custom Report</button>
            </header>

            <!-- Quick Report Generator -->
            <section class="activity">
                <h2>âš¡ Quick Report Generator</h2>
                <div
                    style="padding: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div>
                        <label>City:</label>
                        <input type="text" id="reportCity" value="Bangalore" placeholder="Enter city name">
                    </div>
                    <div>
                        <label>Date Range:</label>
                        <select id="reportRange"
                            style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px;">
                            <option value="7">Last 7 Days</option>
                            <option value="14">Last 14 Days</option>
                            <option value="30" selected>Last 30 Days</option>
                        </select>
                    </div>
                    <div>
                        <label>Format:</label>
                        <select id="reportFormat"
                            style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px;">
                            <option value="pdf">PDF Report</option>
                            <option value="excel">Excel Spreadsheet</option>
                            <option value="json">JSON Data</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: flex-end;">
                        <button onclick="generateReport()" style="width: 100%;">ğŸ“¥ Generate & Download</button>
                    </div>
                </div>
            </section>

            <section class="activity" style="margin-top: 30px;">
                <h2>ğŸ“¥ Available Reports</h2>
                <div style="padding: 20px;">
                    <div class="report-item">
                        <div class="report-info">
                            <h3>ğŸ“„ Daily AQI Summary</h3>
                            <p>Comprehensive daily air quality report with hourly breakdowns</p>
                            <span class="report-meta">Generated: Today | Format: PDF | Size: 2.3 MB</span>
                        </div>
                        <div class="report-actions">
                            <button onclick="downloadReport('daily')">â¬‡ï¸ Download</button>
                            <button onclick="viewReport('daily')" style="background: #2196f3;">ğŸ‘ï¸ View</button>
                        </div>
                    </div>

                    <div class="report-item">
                        <div class="report-info">
                            <h3>ğŸ“Š Weekly Pollution Analysis</h3>
                            <p>7-day pollution trends with pollutant breakdown and forecasts</p>
                            <span class="report-meta">Generated: Yesterday | Format: PDF | Size: 4.7 MB</span>
                        </div>
                        <div class="report-actions">
                            <button onclick="downloadReport('weekly')">â¬‡ï¸ Download</button>
                            <button onclick="viewReport('weekly')" style="background: #2196f3;">ğŸ‘ï¸ View</button>
                        </div>
                    </div>

                    <div class="report-item">
                        <div class="report-info">
                            <h3>ğŸ“ˆ Monthly AQI Trends</h3>
                            <p>Complete monthly overview with comparative analysis</p>
                            <span class="report-meta">Generated: Last week | Format: PDF | Size: 8.1 MB</span>
                        </div>
                        <div class="report-actions">
                            <button onclick="downloadReport('monthly')">â¬‡ï¸ Download</button>
                            <button onclick="viewReport('monthly')" style="background: #2196f3;">ğŸ‘ï¸ View</button>
                        </div>
                    </div>
                </div>
            </section>

            <section class="activity" style="margin-top: 30px;">
                <h2>ğŸ“Š Report Statistics</h2>
                <div class="cards" style="margin-top: 20px;">
                    <div class="card good">
                        <div class="card-header">
                            <h3>Reports Generated</h3>
                            <span class="icon">ğŸ“„</span>
                        </div>
                        <p class="value" id="reportsGenerated">0</p>
                        <span class="unit">This session</span>
                    </div>

                    <div class="card moderate">
                        <div class="card-header">
                            <h3>Downloads</h3>
                            <span class="icon">â¬‡ï¸</span>
                        </div>
                        <p class="value" id="totalDownloads">0</p>
                        <span class="unit">Total</span>
                    </div>

                    <div class="card poor">
                        <div class="card-header">
                            <h3>Data Points</h3>
                            <span class="icon">ğŸ“Š</span>
                        </div>
                        <p class="value" id="dataPoints">--</p>
                        <span class="unit">Available</span>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <style>
        .report-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            margin-bottom: 15px;
            background: #f9f9f9;
            border-radius: 12px;
            border-left: 4px solid #a3ff12;
            transition: all 0.3s;
        }

        .report-item:hover {
            background: #f0f0f0;
            transform: translateX(5px);
        }

        .report-info h3 {
            margin-bottom: 8px;
            color: #333;
        }

        .report-info p {
            color: #666;
            margin-bottom: 8px;
        }

        .report-meta {
            font-size: 13px;
            color: #999;
        }

        .report-actions {
            display: flex;
            gap: 10px;
        }

        @media (max-width: 768px) {
            .report-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .report-actions {
                width: 100%;
            }

            .report-actions button {
                flex: 1;
            }
        }
    </style>

    <script>
        const API_BASE = "http://127.0.0.1:5000";
        let reportsGenerated = 0;
        let totalDownloads = 0;

        async function generateReport() {
            const city = document.getElementById('reportCity').value.trim() || 'Bangalore';
            const days = document.getElementById('reportRange').value;
            const format = document.getElementById('reportFormat').value;

            try {
                // Show loading
                alert('Generating report... Please wait.');

                // Fetch data from API
                const res = await fetch(`${API_BASE}/api/historical?city=${encodeURIComponent(city)}&days=${days}`);
                const data = await res.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                // Update statistics
                reportsGenerated++;
                document.getElementById('reportsGenerated').innerText = reportsGenerated;
                document.getElementById('dataPoints').innerText = data.length;

                if (format === 'pdf') {
                    generatePDFReport(city, data);
                } else if (format === 'excel') {
                    generateExcelReport(city, data);
                } else if (format === 'json') {
                    downloadJSON(city, data);
                }

                totalDownloads++;
                document.getElementById('totalDownloads').innerText = totalDownloads;

            } catch (err) {
                console.error('Error generating report:', err);
                alert('Failed to generate report: ' + err.message);
            }
        }

        function generatePDFReport(city, data) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Title
            doc.setFontSize(20);
            doc.setTextColor(28, 31, 38);
            doc.text('AeroClean Air Quality Report', 20, 20);

            // Subtitle
            doc.setFontSize(12);
            doc.setTextColor(100);
            doc.text(`City: ${city}`, 20, 30);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 20, 37);
            doc.text(`Data Points: ${data.length}`, 20, 44);

            // Summary statistics
            if (data.length > 0) {
                const aqiValues = data.map(d => d.aqi);
                const avgAQI = Math.round(aqiValues.reduce((a, b) => a + b, 0) / aqiValues.length);
                const maxAQI = Math.max(...aqiValues);
                const minAQI = Math.min(...aqiValues);

                doc.setFontSize(14);
                doc.setTextColor(28, 31, 38);
                doc.text('Summary Statistics', 20, 60);

                doc.setFontSize(11);
                doc.text(`Average AQI: ${avgAQI}`, 20, 70);
                doc.text(`Maximum AQI: ${maxAQI}`, 20, 77);
                doc.text(`Minimum AQI: ${minAQI}`, 20, 84);
            }

            // Data table
            doc.setFontSize(14);
            doc.text('Daily Data', 20, 100);

            doc.setFontSize(10);
            let y = 110;

            // Table header
            doc.setFillColor(28, 31, 38);
            doc.setTextColor(255);
            doc.rect(20, y - 5, 170, 8, 'F');
            doc.text('Date', 25, y);
            doc.text('AQI', 70, y);
            doc.text('PM2.5', 100, y);
            doc.text('Status', 140, y);

            doc.setTextColor(28, 31, 38);
            y += 10;

            // Table rows
            data.slice(0, 20).forEach((row, index) => {
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }

                if (index % 2 === 0) {
                    doc.setFillColor(245, 245, 245);
                    doc.rect(20, y - 5, 170, 8, 'F');
                }

                doc.text(row.date, 25, y);
                doc.text(String(row.aqi), 70, y);
                doc.text(String(row.pm2_5), 100, y);
                doc.text(row.status || getAQIStatus(row.aqi), 140, y);
                y += 8;
            });

            // Footer
            doc.setFontSize(8);
            doc.setTextColor(150);
            doc.text('Generated by AeroClean Dashboard - Air Quality Monitoring System', 20, 285);

            // Save
            doc.save(`AeroClean_Report_${city}_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        function generateExcelReport(city, data) {
            // Prepare data for Excel
            const worksheetData = [
                ['AeroClean Air Quality Report'],
                [`City: ${city}`],
                [`Generated: ${new Date().toLocaleString()}`],
                [],
                ['Date', 'AQI', 'PM2.5 (Âµg/mÂ³)', 'PM10 (Âµg/mÂ³)', 'Status']
            ];

            data.forEach(row => {
                worksheetData.push([
                    row.date,
                    row.aqi,
                    row.pm2_5,
                    row.pm10 || '--',
                    row.status || getAQIStatus(row.aqi)
                ]);
            });

            // Summary
            if (data.length > 0) {
                const aqiValues = data.map(d => d.aqi);
                worksheetData.push([]);
                worksheetData.push(['Summary Statistics']);
                worksheetData.push(['Average AQI', Math.round(aqiValues.reduce((a, b) => a + b, 0) / aqiValues.length)]);
                worksheetData.push(['Maximum AQI', Math.max(...aqiValues)]);
                worksheetData.push(['Minimum AQI', Math.min(...aqiValues)]);
            }

            // Create workbook
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(worksheetData);

            // Set column widths
            ws['!cols'] = [
                { wch: 15 },
                { wch: 10 },
                { wch: 15 },
                { wch: 15 },
                { wch: 15 }
            ];

            XLSX.utils.book_append_sheet(wb, ws, 'AQI Data');

            // Download
            XLSX.writeFile(wb, `AeroClean_Report_${city}_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function downloadJSON(city, data) {
            const report = {
                meta: {
                    city: city,
                    generatedAt: new Date().toISOString(),
                    dataPoints: data.length,
                    source: 'AeroClean Dashboard'
                },
                summary: data.length > 0 ? {
                    avgAQI: Math.round(data.map(d => d.aqi).reduce((a, b) => a + b, 0) / data.length),
                    maxAQI: Math.max(...data.map(d => d.aqi)),
                    minAQI: Math.min(...data.map(d => d.aqi))
                } : null,
                data: data
            };

            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `AeroClean_Report_${city}_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function getAQIStatus(aqi) {
            if (aqi <= 50) return "Good";
            if (aqi <= 100) return "Satisfactory";
            if (aqi <= 200) return "Moderate";
            if (aqi <= 300) return "Poor";
            if (aqi <= 400) return "Very Poor";
            return "Severe";
        }

        function downloadReport(type) {
            const reportNames = {
                'daily': 'Daily_AQI_Summary',
                'weekly': 'Weekly_Pollution_Analysis',
                'monthly': 'Monthly_AQI_Trends'
            };

            // Use current settings
            document.getElementById('reportCity').value = document.getElementById('reportCity').value || 'Bangalore';
            document.getElementById('reportRange').value = type === 'daily' ? '7' : type === 'weekly' ? '7' : '30';
            generateReport();
        }

        function viewReport(type) {
            const city = document.getElementById('reportCity').value || 'Bangalore';

            const reportContent = {
                'daily': `Daily AQI Summary - ${new Date().toLocaleDateString()}

=== Overview ===
City: ${city}
Average AQI: Loading...
Peak AQI: Loading...

Click 'Generate & Download' to create a detailed report.`,

                'weekly': 'Weekly analysis - Use the report generator for detailed data.',
                'monthly': 'Monthly trends - Use the report generator for detailed data.'
            };

            alert(reportContent[type] || 'Report preview not available');
        }

        function generateCustomReport() {
            alert(`Custom Report Generator

Use the Quick Report Generator above to:
1. Select your city
2. Choose date range (7, 14, or 30 days)
3. Pick your preferred format (PDF, Excel, or JSON)
4. Click "Generate & Download"

The report will be generated from live API data.`);
        }
    </script>

</body>

</html>