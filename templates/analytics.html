<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - AeroClean</title>
    <meta name="description" content="Air quality analytics with interactive maps and explainable AI insights">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet MarkerCluster -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <style>
        .monitor-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .monitor-grid {
                grid-template-columns: 1fr;
            }
        }

        .ranking-card {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .ranking-card.clean {
            border-top: 4px solid #4caf50;
        }

        .ranking-card.polluted {
            border-top: 4px solid #f44336;
        }

        .ranking-header h3 {
            margin-bottom: 15px;
            font-size: 16px;
        }

        .ranking-list {
            list-style: none;
            padding: 0;
        }

        .ranking-list li {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .ranking-list li:last-child {
            border-bottom: none;
        }

        .rank-aqi {
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            color: white;
        }

        .legend-dot {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .xai-bar {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .xai-bar-label {
            width: 60px;
            font-weight: 600;
        }

        .xai-bar-container {
            flex: 1;
            height: 24px;
            background: #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
            margin: 0 10px;
        }

        .xai-bar-fill {
            height: 100%;
            border-radius: 12px;
            transition: width 0.5s ease;
        }

        .xai-bar-value {
            width: 50px;
            text-align: right;
            font-weight: 600;
        }

        .impact-high {
            color: #f44336;
        }

        .impact-medium {
            color: #ff9800;
        }

        .impact-low {
            color: #4caf50;
        }
    </style>
</head>

<body>
    <div class="dashboard">
        <aside class="sidebar">
            <h2 class="logo">üåø AeroClean</h2>
            <ul>
                <li onclick="location.href='index.html'"><span class="icon">üìä</span><span>Dashboard</span></li>
                <li class="active"><span class="icon">üìà</span><span>Analytics</span></li>
                <li onclick="location.href='devices.html'"><span class="icon">üì°</span><span>Devices</span></li>
                <li onclick="location.href='reports.html'"><span class="icon">üìë</span><span>Reports</span></li>
                <li onclick="location.href='settings.html'"><span class="icon">‚öôÔ∏è</span><span>Settings</span></li>
            </ul>
        </aside>
        <main class="main">
            <header class="topbar">
                <h1>üìà Air Quality Analytics</h1>
                <div class="search-box">
                    <input type="text" id="citySearch" list="citySuggestions" placeholder="üîç Search city..."
                        aria-label="Search city" oninput="handleSearchInput(this.value)">
                    <datalist id="citySuggestions"></datalist>
                    <button onclick="loadAnalytics()">Refresh</button>
                </div>
            </header>
            <section class="cards">
                <div class="card good">
                    <div class="card-header">
                        <h3>7-Day Average AQI</h3><span class="icon">üìä</span>
                    </div>
                    <p class="value" id="avgAQI">--</p>
                </div>
                <div class="card moderate">
                    <div class="card-header">
                        <h3>Highest Recorded</h3><span class="icon">‚¨ÜÔ∏è</span>
                    </div>
                    <p class="value" id="maxAQI">--</p>
                </div>
                <div class="card poor">
                    <div class="card-header">
                        <h3>Lowest Recorded</h3><span class="icon">‚¨áÔ∏è</span>
                    </div>
                    <p class="value" id="minAQI">--</p>
                </div>
                <div class="card unhealthy">
                    <div class="card-header">
                        <h3>Trend</h3><span class="icon">üìâ</span>
                    </div>
                    <p class="value" id="trend">--</p>
                </div>
            </section>
            <!-- City Rankings Section -->
            <section class="activity" style="margin-bottom: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>üèÜ National AQI Rankings</h2>
                    <div class="ranking-controls" style="background: #f5f5f5; padding: 5px; border-radius: 8px;">
                        <label style="cursor: pointer; margin-right: 15px; padding: 5px 10px; border-radius: 6px;">
                            <input type="radio" name="rankTimeframe" value="live" checked onchange="loadRankings()">
                            Live
                        </label>
                        <label style="cursor: pointer; padding: 5px 10px; border-radius: 6px;">
                            <input type="radio" name="rankTimeframe" value="monthly" onchange="loadRankings()"> Last 30
                            Days
                        </label>
                    </div>
                </div>
                <div class="monitor-grid">
                    <div class="ranking-card clean">
                        <div class="ranking-header">
                            <h3>üçÉ Top 5 Cleanest Cities</h3>
                        </div>
                        <ul class="ranking-list" id="cleanestCitiesList">
                            <li>Loading...</li>
                        </ul>
                    </div>
                    <div class="ranking-card polluted">
                        <div class="ranking-header">
                            <h3>üè≠ Top 5 Most Polluted Cities</h3>
                        </div>
                        <ul class="ranking-list" id="pollutedCitiesList">
                            <li>Loading...</li>
                        </ul>
                    </div>
                </div>
            </section>
            <!-- Interactive Map Section -->
            <section class="activity">
                <h2>üó∫Ô∏è Interactive AQI Map (Live)</h2>
                <div id="aqiMap" style="height: 500px; border-radius: 12px; margin-top: 15px;"></div>
                <div class="map-legend" style="margin-top: 10px; display: flex; gap: 15px; flex-wrap: wrap;">
                    <span><span class="legend-dot" style="background: #4caf50;"></span> Good (0-50)</span>
                    <span><span class="legend-dot" style="background: #ffc107;"></span> Satisfactory (51-100)</span>
                    <span><span class="legend-dot" style="background: #ff9800;"></span> Moderate (101-200)</span>
                    <span><span class="legend-dot" style="background: #f44336;"></span> Poor (201-300)</span>
                    <span><span class="legend-dot" style="background: #9c27b0;"></span> Severe (300+)</span>
                </div>
            </section>
            <!-- XAI Section -->
            <section class="activity" style="margin-top: 30px;">
                <h2>üß† Explainable AI - Pollutant Impact Analysis</h2>
                <p id="xaiExplanation" style="color: #666; margin-bottom: 15px;">Loading explanation...</p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div style="position: relative; height: 300px;"><canvas id="xaiChart"></canvas></div>
                    <div id="xaiDetails" style="padding: 15px; background: #f9f9f9; border-radius: 12px;">
                        <h4 style="margin-bottom: 15px;">Pollutant Contributions</h4>
                        <div id="pollutantBreakdown">Loading...</div>
                    </div>
                </div>
            </section>
            <section class="activity" style="margin-top: 30px;">
                <h2>üìâ Historical AQI Trend (Last 30 Days)</h2>
                <div style="margin-bottom: 15px;">
                    <label for="daysSelect">Time Range:</label>
                    <select id="daysSelect" onchange="loadAnalytics()"
                        style="padding: 8px; border-radius: 8px; margin-left: 10px;">
                        <option value="7">7 Days</option>
                        <option value="14">14 Days</option>
                        <option value="30" selected>30 Days</option>
                    </select>
                </div>
                <div style="position: relative; height: 400px; padding: 20px;"><canvas id="aqiChart"></canvas></div>
            </section>
            <section class="activity" style="margin-top: 30px;">
                <h2>üìä Pollutant Breakdown</h2>
                <div style="position: relative; height: 350px; padding: 20px;"><canvas id="pollutantChart"></canvas>
                </div>
            </section>
            <section class="activity" style="margin-top: 30px;">
                <h2>üìÖ Historical Data</h2>
                <div id="historicalTable">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>AQI</th>
                                <th>PM2.5 (¬µg/m¬≥)</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr>
                                <td colspan="4" style="text-align: center;">Loading data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>
    <script>
        const API_BASE = "http://127.0.0.1:5000";
        let currentCity = localStorage.getItem('selectedCity') || "Bangalore";
        let aqiChart = null, pollutantChart = null, xaiChart = null, map = null, markers = null;
        let debounceTimer;

        function handleSearchInput(query) {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                if (query.length < 2) return;
                fetch(`${API_BASE}/api/cities?q=${encodeURIComponent(query)}`)
                    .then(res => res.json())
                    .then(data => {
                        const dl = document.getElementById('citySuggestions');
                        dl.innerHTML = '';
                        data.forEach(item => {
                            const opt = document.createElement('option');
                            opt.value = item.name;
                            opt.label = item.display_name;
                            dl.appendChild(opt);
                        });
                    });
            }, 300);
        }

        function getAQIStatus(aqi) {
            if (aqi <= 50) return "Good";
            if (aqi <= 100) return "Satisfactory";
            if (aqi <= 200) return "Moderate";
            if (aqi <= 300) return "Poor";
            if (aqi <= 400) return "Very Poor";
            return "Severe";
        }
        function getAQIColor(aqi) {
            if (aqi <= 50) return "#4caf50";
            if (aqi <= 100) return "#ffc107";
            if (aqi <= 200) return "#ff9800";
            if (aqi <= 300) return "#f44336";
            return "#9c27b0";
        }

        function initMap() {
            if (map) map.remove();
            map = L.map('aqiMap').setView([22.5937, 78.9629], 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap contributors' }).addTo(map);
            markers = L.markerClusterGroup();
            map.addLayer(markers);
            loadCityMarkers();
        }

        async function loadCityMarkers() {
            try {
                const res = await fetch(`${API_BASE}/api/map-data`);
                const locations = await res.json();
                if (locations.error) throw new Error(locations.error);
                markers.clearLayers();
                locations.forEach(loc => {
                    const color = getAQIColor(loc.aqi);
                    const customIcon = L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div style='background-color:${color}; width:12px; height:12px; border-radius:50%; border:2px solid white;'></div>`,
                        iconSize: [16, 16],
                        iconAnchor: [8, 8]
                    });
                    const marker = L.marker([loc.lat, loc.lon], { icon: customIcon });
                    marker.bindPopup(`
                        <div style="text-align: center; min-width: 150px;">
                            <b>${loc.name}</b><br>
                            <span style="font-size: 10px; color: #666;">${loc.city}</span><br>
                            <span style="font-size: 18px; font-weight: bold; color: ${color};">AQI: ${loc.aqi}</span><br>
                            <span style="font-size: 12px; font-weight: bold;">${loc.status}</span><br>
                            <hr style="margin: 5px 0; border: 0; border-top: 1px solid #eee;">
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px; font-size:11px;">
                                <span>PM2.5: <b>${loc.pm2_5}</b></span>
                                <span>PM10: <b>${loc.pm10}</b></span>
                            </div>
                        </div>
                    `);
                    markers.addLayer(marker);
                });
            } catch (err) { console.error("Error loading map data:", err); }
        }

        async function loadXAI() {
            try {
                const res = await fetch(`${API_BASE}/api/explain?city=${encodeURIComponent(currentCity)}`);
                const data = await res.json();
                if (data.error) throw new Error(data.error);
                document.getElementById('xaiExplanation').innerText = data.explanation;
                const breakdown = document.getElementById('pollutantBreakdown');
                breakdown.innerHTML = '';
                const colors = { 'PM2.5': '#f44336', 'PM10': '#ff9800', 'NO2': '#ffc107', 'SO2': '#4caf50', 'O3': '#2196f3', 'CO': '#9c27b0' };
                for (const [pollutant, info] of Object.entries(data.feature_importance)) {
                    const impactClass = info.impact === 'high' ? 'impact-high' : info.impact === 'medium' ? 'impact-medium' : 'impact-low';
                    breakdown.innerHTML += `
                        <div class="xai-bar">
                            <span class="xai-bar-label">${pollutant}</span>
                            <div class="xai-bar-container"><div class="xai-bar-fill" style="width: ${info.contribution}%; background: ${colors[pollutant] || '#666'}"></div></div>
                            <span class="xai-bar-value ${impactClass}">${info.contribution}%</span>
                        </div>`;
                }
                updateXAIChart(data.feature_importance);
            } catch (err) { console.error("Error loading XAI:", err); document.getElementById('xaiExplanation').innerText = "Unable to load explanation"; }
        }

        function updateXAIChart(importance) {
            const ctx = document.getElementById('xaiChart').getContext('2d');
            if (xaiChart) xaiChart.destroy();
            const labels = Object.keys(importance);
            const contributions = labels.map(k => importance[k].contribution);
            xaiChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{ data: contributions, backgroundColor: ['#f44336', '#ff9800', '#ffc107', '#4caf50', '#2196f3', '#9c27b0'], borderWidth: 2, borderColor: '#fff' }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' }, title: { display: true, text: 'AQI Contribution by Pollutant' } } }
            });
        }

        async function loadAnalytics() {
            const input = document.getElementById("citySearch");
            currentCity = input.value.trim() || "Bangalore";
            localStorage.setItem('selectedCity', currentCity);
            const days = document.getElementById("daysSelect")?.value || 7;
            try {
                const histRes = await fetch(`${API_BASE}/api/historical?city=${encodeURIComponent(currentCity)}&days=${days}`);
                const histData = await histRes.json();
                if (histData.error) throw new Error(histData.error);
                if (histData.length > 0) {
                    const aqiValues = histData.map(d => d.aqi);
                    const avgAQI = Math.round(aqiValues.reduce((a, b) => a + b, 0) / aqiValues.length);
                    document.getElementById("avgAQI").innerText = avgAQI;
                    document.getElementById("maxAQI").innerText = Math.max(...aqiValues);
                    document.getElementById("minAQI").innerText = Math.min(...aqiValues);
                    document.getElementById("trend").innerText = aqiValues[aqiValues.length - 1] > aqiValues[0] ? "‚ÜóÔ∏è Rising" : "‚ÜòÔ∏è Falling";
                    updateAQIChart(histData);
                    updateTable(histData);
                }
                const currRes = await fetch(`${API_BASE}/api/current?city=${encodeURIComponent(currentCity)}`);
                const currData = await currRes.json();
                if (currData.current) updatePollutantChart(currData.current);
                loadXAI();
            } catch (err) { console.error("Error loading analytics:", err); alert("Failed to load analytics: " + err.message); }
        }

        function updateAQIChart(data) {
            const ctx = document.getElementById('aqiChart').getContext('2d');
            if (aqiChart) aqiChart.destroy();
            aqiChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'AQI', data: data.map(d => d.aqi), borderColor: '#a3ff12', backgroundColor: 'rgba(163, 255, 18, 0.1)',
                        borderWidth: 3, tension: 0.4, fill: true, pointRadius: 5, pointHoverRadius: 7, pointBackgroundColor: data.map(d => getAQIColor(d.aqi))
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: true, position: 'top' }, tooltip: { callbacks: { label: function (c) { return `AQI: ${c.parsed.y} (${getAQIStatus(c.parsed.y)})`; } } } },
                    scales: { y: { beginAtZero: true, title: { display: true, text: 'AQI Value' } }, x: { title: { display: true, text: 'Date' } } }
                }
            });
        }

        function updatePollutantChart(current) {
            const ctx = document.getElementById('pollutantChart').getContext('2d');
            if (pollutantChart) pollutantChart.destroy();
            pollutantChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['PM2.5', 'PM10', 'NO‚ÇÇ', 'SO‚ÇÇ', 'CO', 'O‚ÇÉ'],
                    datasets: [{
                        label: 'Concentration (¬µg/m¬≥)',
                        data: [current.pm2_5, current.pm10, current.no2, current.so2, current.co / 100, current.o3],
                        backgroundColor: ['#f44336', '#ff9800', '#ffc107', '#4caf50', '#2196f3', '#9c27b0'], borderWidth: 0, borderRadius: 8
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, title: { display: true, text: 'Concentration (¬µg/m¬≥)' } } } }
            });
        }

        function updateTable(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${row.date}</td><td><strong>${row.aqi}</strong></td><td>${row.pm2_5}</td><td><span style="color: ${getAQIColor(row.aqi)}; font-weight: 600;">${getAQIStatus(row.aqi)}</span></td>`;
                tbody.appendChild(tr);
            });
        }

        async function loadRankings() {
            const timeframe = document.querySelector('input[name="rankTimeframe"]:checked').value;
            const container = document.querySelector('.monitor-grid');
            container.style.opacity = '0.5';
            try {
                const res = await fetch(`${API_BASE}/api/rankings?timeframe=${timeframe}`);
                const data = await res.json();
                container.style.opacity = '1';
                if (data.cleanest) {
                    const cleanList = document.getElementById('cleanestCitiesList');
                    cleanList.innerHTML = '';
                    data.cleanest.forEach(city => {
                        cleanList.innerHTML += `<li><span>${city.name}</span><span class="rank-aqi" style="background: ${city.color === 'good' ? '#4caf50' : '#8bc34a'}">${timeframe === 'monthly' ? 'Avg ' : ''}AQI ${city.aqi}</span></li>`;
                    });
                }
                if (data.polluted) {
                    const pollutedList = document.getElementById('pollutedCitiesList');
                    pollutedList.innerHTML = '';
                    data.polluted.forEach(city => {
                        pollutedList.innerHTML += `<li><span>${city.name}</span><span class="rank-aqi" style="background: ${city.color === 'severe' ? '#9c27b0' : '#f44336'}">${timeframe === 'monthly' ? 'Avg ' : ''}AQI ${city.aqi}</span></li>`;
                    });
                }
            } catch (err) { console.error("Error loading rankings:", err); container.style.opacity = '1'; document.getElementById('cleanestCitiesList').innerHTML = '<li>Error loading data</li>'; }
        }

        document.addEventListener("DOMContentLoaded", () => {
            initMap();
            loadAnalytics();
            loadRankings();
            const searchInput = document.getElementById("citySearch");
            if (searchInput && currentCity !== "Bangalore") searchInput.value = currentCity;
            searchInput.addEventListener("keypress", (e) => { if (e.key === "Enter") loadAnalytics(); });
        });
    </script>
</body>

</html>