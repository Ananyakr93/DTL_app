<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - AeroClean</title>
    <meta name="description" content="Air quality analytics with interactive maps and explainable AI insights">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Leaflet CSS for Interactive Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body>

    <div class="dashboard">
        <aside class="sidebar">
            <h2 class="logo">üåø AeroClean</h2>
            <ul>
                <li onclick="location.href='index.html'">
                    <span class="icon">üìä</span>
                    <span>Dashboard</span>
                </li>
                <li class="active">
                    <span class="icon">üìà</span>
                    <span>Analytics</span>
                </li>
                <li onclick="location.href='devices.html'">
                    <span class="icon">üì°</span>
                    <span>Devices</span>
                </li>
                <li onclick="location.href='reports.html'">
                    <span class="icon">üìë</span>
                    <span>Reports</span>
                </li>
                <li onclick="location.href='settings.html'">
                    <span class="icon">‚öôÔ∏è</span>
                    <span>Settings</span>
                </li>
            </ul>
        </aside>

        <main class="main">
            <header class="topbar">
                <h1>üìà Air Quality Analytics</h1>
                <div class="search-box">
                    <input type="text" id="citySearch" placeholder="üîç Search city..." value="Bangalore"
                        aria-label="Search city">
                    <button onclick="loadAnalytics()">Refresh</button>
                </div>
            </header>

            <section class="cards">
                <div class="card good">
                    <div class="card-header">
                        <h3>7-Day Average AQI</h3>
                        <span class="icon">üìä</span>
                    </div>
                    <p class="value" id="avgAQI">--</p>
                </div>

                <div class="card moderate">
                    <div class="card-header">
                        <h3>Highest Recorded</h3>
                        <span class="icon">‚¨ÜÔ∏è</span>
                    </div>
                    <p class="value" id="maxAQI">--</p>
                </div>

                <div class="card poor">
                    <div class="card-header">
                        <h3>Lowest Recorded</h3>
                        <span class="icon">‚¨áÔ∏è</span>
                    </div>
                    <p class="value" id="minAQI">--</p>
                </div>

                <div class="card unhealthy">
                    <div class="card-header">
                        <h3>Trend</h3>
                        <span class="icon">üìâ</span>
                    </div>
                    <p class="value" id="trend">--</p>
                </div>
            </section>

            <!-- Interactive Map Section -->
            <section class="activity">
                <h2>üó∫Ô∏è Interactive AQI Map</h2>
                <div id="aqiMap" style="height: 400px; border-radius: 12px; margin-top: 15px;"></div>
                <div class="map-legend" style="margin-top: 10px; display: flex; gap: 15px; flex-wrap: wrap;">
                    <span><span class="legend-dot" style="background: #4caf50;"></span> Good (0-50)</span>
                    <span><span class="legend-dot" style="background: #ffc107;"></span> Satisfactory (51-100)</span>
                    <span><span class="legend-dot" style="background: #ff9800;"></span> Moderate (101-200)</span>
                    <span><span class="legend-dot" style="background: #f44336;"></span> Poor (201-300)</span>
                    <span><span class="legend-dot" style="background: #9c27b0;"></span> Severe (300+)</span>
                </div>
            </section>

            <!-- XAI Section - Explainable AI -->
            <section class="activity" style="margin-top: 30px;">
                <h2>üß† Explainable AI - Pollutant Impact Analysis</h2>
                <p id="xaiExplanation" style="color: #666; margin-bottom: 15px;">Loading explanation...</p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div style="position: relative; height: 300px;">
                        <canvas id="xaiChart"></canvas>
                    </div>
                    <div id="xaiDetails" style="padding: 15px; background: #f9f9f9; border-radius: 12px;">
                        <h4 style="margin-bottom: 15px;">Pollutant Contributions</h4>
                        <div id="pollutantBreakdown">Loading...</div>
                    </div>
                </div>
            </section>

            <section class="activity" style="margin-top: 30px;">
                <h2>üìâ Historical AQI Trend (Last 30 Days)</h2>
                <div style="margin-bottom: 15px;">
                    <label for="daysSelect">Time Range:</label>
                    <select id="daysSelect" onchange="loadAnalytics()"
                        style="padding: 8px; border-radius: 8px; margin-left: 10px;">
                        <option value="7">7 Days</option>
                        <option value="14">14 Days</option>
                        <option value="30" selected>30 Days</option>
                    </select>
                </div>
                <div style="position: relative; height: 400px; padding: 20px;">
                    <canvas id="aqiChart"></canvas>
                </div>
            </section>

            <section class="activity" style="margin-top: 30px;">
                <h2>üìä Pollutant Breakdown</h2>
                <div style="position: relative; height: 350px; padding: 20px;">
                    <canvas id="pollutantChart"></canvas>
                </div>
            </section>

            <section class="activity" style="margin-top: 30px;">
                <h2>üìÖ Historical Data</h2>
                <div id="historicalTable">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>AQI</th>
                                <th>PM2.5 (¬µg/m¬≥)</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr>
                                <td colspan="4" style="text-align: center;">Loading data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <style>
        .legend-dot {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .xai-bar {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .xai-bar-label {
            width: 60px;
            font-weight: 600;
        }

        .xai-bar-container {
            flex: 1;
            height: 24px;
            background: #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
            margin: 0 10px;
        }

        .xai-bar-fill {
            height: 100%;
            border-radius: 12px;
            transition: width 0.5s ease;
        }

        .xai-bar-value {
            width: 50px;
            text-align: right;
            font-weight: 600;
        }

        .impact-high {
            color: #f44336;
        }

        .impact-medium {
            color: #ff9800;
        }

        .impact-low {
            color: #4caf50;
        }
    </style>

    <script>
        const API_BASE = "http://127.0.0.1:5000";
        let currentCity = "Bangalore";
        let aqiChart = null;
        let pollutantChart = null;
        let xaiChart = null;
        let map = null;

        // Expanded Indian cities and landmarks for map
        const indianCities = [
            // Metros
            { name: "Delhi", lat: 28.6139, lon: 77.2090 },
            { name: "Mumbai", lat: 19.0760, lon: 72.8777 },
            { name: "Bangalore", lat: 12.9716, lon: 77.5946 },
            { name: "Chennai", lat: 13.0827, lon: 80.2707 },
            { name: "Kolkata", lat: 22.5726, lon: 88.3639 },
            { name: "Hyderabad", lat: 17.3850, lon: 78.4867 },
            { name: "Pune", lat: 18.5204, lon: 73.8567 },
            { name: "Ahmedabad", lat: 23.0225, lon: 72.5714 },
            // Tier 2 Cities
            { name: "Jaipur", lat: 26.9124, lon: 75.7873 },
            { name: "Lucknow", lat: 26.8467, lon: 80.9462 },
            { name: "Kanpur", lat: 26.4499, lon: 80.3319 },
            { name: "Nagpur", lat: 21.1458, lon: 79.0882 },
            { name: "Indore", lat: 22.7196, lon: 75.8577 },
            { name: "Thane", lat: 19.2183, lon: 72.9781 },
            { name: "Bhopal", lat: 23.2599, lon: 77.4126 },
            { name: "Visakhapatnam", lat: 17.6868, lon: 83.2185 },
            { name: "Pimpri-Chinchwad", lat: 18.6298, lon: 73.7997 },
            { name: "Patna", lat: 25.5941, lon: 85.1376 },
            { name: "Vadodara", lat: 22.3072, lon: 73.1812 },
            { name: "Ghaziabad", lat: 28.6692, lon: 77.4538 },
            { name: "Ludhiana", lat: 30.9010, lon: 75.8573 },
            { name: "Agra", lat: 27.1767, lon: 78.0081 },
            { name: "Nashik", lat: 19.9975, lon: 73.7898 },
            { name: "Faridabad", lat: 28.4089, lon: 77.3178 },
            { name: "Meerut", lat: 28.9845, lon: 77.7064 },
            { name: "Rajkot", lat: 22.3039, lon: 70.8022 },
            { name: "Varanasi", lat: 25.3176, lon: 82.9739 },
            { name: "Srinagar", lat: 34.0837, lon: 74.7973 },
            { name: "Aurangabad", lat: 19.8762, lon: 75.3433 },
            { name: "Dhanbad", lat: 23.7957, lon: 86.4304 },
            // Landmarks / Specific Places
            { name: "Delhi - Connaught Place", lat: 28.6304, lon: 77.2177 },
            { name: "Delhi - India Gate", lat: 28.6129, lon: 77.2295 },
            { name: "Mumbai - Gateway of India", lat: 18.9220, lon: 72.8347 },
            { name: "Mumbai - Bandra West", lat: 19.0596, lon: 72.8295 },
            { name: "Bangalore - Whitefield", lat: 12.9698, lon: 77.7500 },
            { name: "Bangalore - Electronic City", lat: 12.8452, lon: 77.6602 },
            { name: "Kolkata - Victoria Memorial", lat: 22.5448, lon: 88.3426 },
            { name: "Hyderabad - Charminar", lat: 17.3616, lon: 78.4747 },
            { name: "Chennai - Marina Beach", lat: 13.0500, lon: 80.2824 }
        ];

        function getAQIStatus(aqi) {
            if (aqi <= 50) return "Good";
            if (aqi <= 100) return "Satisfactory";
            if (aqi <= 200) return "Moderate";
            if (aqi <= 300) return "Poor";
            if (aqi <= 400) return "Very Poor";
            return "Severe";
        }

        function getAQIColor(aqi) {
            if (aqi <= 50) return "#4caf50";
            if (aqi <= 100) return "#ffc107";
            if (aqi <= 200) return "#ff9800";
            if (aqi <= 300) return "#f44336";
            return "#9c27b0";
        }

        // Initialize Leaflet Map
        function initMap() {
            if (map) {
                map.remove();
            }

            map = L.map('aqiMap').setView([20.5937, 78.9629], 5); // Center on India

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // Add markers for each city
            loadCityMarkers();
        }

        async function loadCityMarkers() {
            for (const city of indianCities) {
                try {
                    const res = await fetch(`${API_BASE}/api/current?city=${city.name}`);
                    const data = await res.json();

                    if (data.current) {
                        const aqi = data.current.aqi_value;
                        const color = getAQIColor(aqi);

                        // Create custom marker
                        const markerHtml = `
                    <div style="
                        background: ${color};
                        color: white;
                        padding: 5px 10px;
                        border-radius: 20px;
                        font-weight: bold;
                        font-size: 12px;
                        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
                        text-align: center;
                        min-width: 40px;
                    ">
                        ${aqi}
                    </div>
                `;

                        const customIcon = L.divIcon({
                            html: markerHtml,
                            className: 'custom-aqi-marker',
                            iconSize: [50, 30],
                            iconAnchor: [25, 15]
                        });

                        L.marker([city.lat, city.lon], { icon: customIcon })
                            .addTo(map)
                            .bindPopup(`
                        <b>${city.name}</b><br>
                        AQI: ${aqi} (${getAQIStatus(aqi)})<br>
                        PM2.5: ${data.current.pm2_5} ¬µg/m¬≥<br>
                        PM10: ${data.current.pm10} ¬µg/m¬≥
                    `);
                    }
                } catch (err) {
                    console.error(`Error loading ${city.name}:`, err);
                }
            }
        }

        // Load XAI Explanation
        async function loadXAI() {
            try {
                const res = await fetch(`${API_BASE}/api/explain?city=${encodeURIComponent(currentCity)}`);
                const data = await res.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                // Update explanation text
                document.getElementById('xaiExplanation').innerText = data.explanation;

                // Update pollutant breakdown
                const breakdown = document.getElementById('pollutantBreakdown');
                breakdown.innerHTML = '';

                const colors = {
                    'PM2.5': '#f44336',
                    'PM10': '#ff9800',
                    'NO2': '#ffc107',
                    'SO2': '#4caf50',
                    'O3': '#2196f3',
                    'CO': '#9c27b0'
                };

                for (const [pollutant, info] of Object.entries(data.feature_importance)) {
                    const impactClass = info.impact === 'high' ? 'impact-high' :
                        info.impact === 'medium' ? 'impact-medium' : 'impact-low';

                    const barHtml = `
                <div class="xai-bar">
                    <span class="xai-bar-label">${pollutant}</span>
                    <div class="xai-bar-container">
                        <div class="xai-bar-fill" style="width: ${info.contribution}%; background: ${colors[pollutant] || '#666'}"></div>
                    </div>
                    <span class="xai-bar-value ${impactClass}">${info.contribution}%</span>
                </div>
            `;
                    breakdown.innerHTML += barHtml;
                }

                // Update XAI chart
                updateXAIChart(data.feature_importance);

            } catch (err) {
                console.error("Error loading XAI:", err);
                document.getElementById('xaiExplanation').innerText = "Unable to load explanation";
            }
        }

        function updateXAIChart(importance) {
            const ctx = document.getElementById('xaiChart').getContext('2d');

            if (xaiChart) {
                xaiChart.destroy();
            }

            const labels = Object.keys(importance);
            const contributions = labels.map(k => importance[k].contribution);

            xaiChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: contributions,
                        backgroundColor: [
                            '#f44336', '#ff9800', '#ffc107', '#4caf50', '#2196f3', '#9c27b0'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: 'AQI Contribution by Pollutant'
                        }
                    }
                }
            });
        }

        async function loadAnalytics() {
            const input = document.getElementById("citySearch");
            currentCity = input.value.trim() || "Bangalore";
            const days = document.getElementById("daysSelect")?.value || 7;

            try {
                // Fetch historical data
                const histRes = await fetch(`${API_BASE}/api/historical?city=${encodeURIComponent(currentCity)}&days=${days}`);
                const histData = await histRes.json();

                if (histData.error) {
                    throw new Error(histData.error);
                }

                // Calculate statistics
                if (histData.length > 0) {
                    const aqiValues = histData.map(d => d.aqi);
                    const avgAQI = Math.round(aqiValues.reduce((a, b) => a + b, 0) / aqiValues.length);
                    const maxAQI = Math.max(...aqiValues);
                    const minAQI = Math.min(...aqiValues);

                    const trend = aqiValues[aqiValues.length - 1] > aqiValues[0] ? "‚ÜóÔ∏è Rising" : "‚ÜòÔ∏è Falling";

                    document.getElementById("avgAQI").innerText = avgAQI;
                    document.getElementById("maxAQI").innerText = maxAQI;
                    document.getElementById("minAQI").innerText = minAQI;
                    document.getElementById("trend").innerText = trend;

                    // Update AQI chart
                    updateAQIChart(histData);

                    // Update table
                    updateTable(histData);
                }

                // Fetch current data for pollutant breakdown
                const currRes = await fetch(`${API_BASE}/api/current?city=${encodeURIComponent(currentCity)}`);
                const currData = await currRes.json();

                if (currData.current) {
                    updatePollutantChart(currData.current);
                }

                // Load XAI explanation
                loadXAI();

            } catch (err) {
                console.error("Error loading analytics:", err);
                alert("Failed to load analytics: " + err.message);
            }
        }

        function updateAQIChart(data) {
            const ctx = document.getElementById('aqiChart').getContext('2d');

            if (aqiChart) {
                aqiChart.destroy();
            }

            aqiChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'AQI',
                        data: data.map(d => d.aqi),
                        borderColor: '#a3ff12',
                        backgroundColor: 'rgba(163, 255, 18, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointBackgroundColor: data.map(d => getAQIColor(d.aqi))
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `AQI: ${context.parsed.y} (${getAQIStatus(context.parsed.y)})`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'AQI Value'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        }
                    }
                }
            });
        }

        function updatePollutantChart(current) {
            const ctx = document.getElementById('pollutantChart').getContext('2d');

            if (pollutantChart) {
                pollutantChart.destroy();
            }

            pollutantChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['PM2.5', 'PM10', 'NO‚ÇÇ', 'SO‚ÇÇ', 'CO', 'O‚ÇÉ'],
                    datasets: [{
                        label: 'Concentration (¬µg/m¬≥)',
                        data: [
                            current.pm2_5,
                            current.pm10,
                            current.no2,
                            current.so2,
                            current.co / 100, // Scale CO for visibility
                            current.o3
                        ],
                        backgroundColor: [
                            '#f44336',
                            '#ff9800',
                            '#ffc107',
                            '#4caf50',
                            '#2196f3',
                            '#9c27b0'
                        ],
                        borderWidth: 0,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Concentration (¬µg/m¬≥)'
                            }
                        }
                    }
                }
            });
        }

        function updateTable(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
            <td>${row.date}</td>
            <td><strong>${row.aqi}</strong></td>
            <td>${row.pm2_5}</td>
            <td><span style="color: ${getAQIColor(row.aqi)}; font-weight: 600;">${getAQIStatus(row.aqi)}</span></td>
        `;
                tbody.appendChild(tr);
            });
        }

        // Initialize on page load
        document.addEventListener("DOMContentLoaded", () => {
            initMap();
            loadAnalytics();

            document.getElementById("citySearch").addEventListener("keypress", (e) => {
                if (e.key === "Enter") {
                    loadAnalytics();
                }
            });
        });
    </script>

</body>

</html>